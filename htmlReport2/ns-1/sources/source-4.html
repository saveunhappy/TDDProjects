


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > ContextConfig</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.geektime.tdd</a>
</div>

<h1>Coverage Summary for Class: ContextConfig (com.geektime.tdd)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ContextConfig</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (14/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (45/45)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ContextConfig$1</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (2/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (7/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ContextConfig$Illegal</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (16/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (52/52)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.geektime.tdd;
&nbsp;
&nbsp;import jakarta.inject.Provider;
&nbsp;import jakarta.inject.Qualifier;
&nbsp;import jakarta.inject.Scope;
&nbsp;import jakarta.inject.Singleton;
&nbsp;
&nbsp;import java.lang.annotation.Annotation;
&nbsp;import java.util.*;
&nbsp;import java.util.stream.Collectors;
&nbsp;import java.util.stream.Stream;
&nbsp;
&nbsp;import static java.util.Arrays.stream;
&nbsp;
&nbsp;public class ContextConfig {
<b class="fc">&nbsp;    private Map&lt;Component, ComponentProvider&lt;?&gt;&gt; components = new HashMap&lt;&gt;();</b>
<b class="fc">&nbsp;    private Map&lt;Class&lt;?&gt;, ScopeProvider&gt; scopes = new HashMap&lt;&gt;();</b>
&nbsp;
<b class="fc">&nbsp;    public ContextConfig() {</b>
<b class="fc">&nbsp;        scope(Singleton.class, SingletonProvider::new);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;Type&gt; void bind(Class&lt;Type&gt; type, Type instance) {
<b class="fc">&nbsp;        components.put(new Component(type, null), context -&gt; instance);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;Type&gt; void bind(Class&lt;Type&gt; type, Type instance, Annotation... qualifiers) {
<b class="fc">&nbsp;        if (stream(qualifiers).anyMatch(q -&gt; !q.annotationType().isAnnotationPresent(Qualifier.class))) {</b>
<b class="fc">&nbsp;            throw new IllegalComponentException();</b>
&nbsp;        }
<b class="fc">&nbsp;        for (Annotation qualifier : qualifiers) {</b>
<b class="fc">&nbsp;            components.put(new Component(type, qualifier), context -&gt; instance);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    public &lt;Type, Implementation extends Type&gt;
&nbsp;    void bind(Class&lt;Type&gt; type, Class&lt;Implementation&gt; implementation) {
&nbsp;        //components.put(new Component(type, null), new InjectionProvider&lt;&gt;(implementation));
&nbsp;        //可以使用delegate的方式，既然是类上面有注解，那么就获取这个类上的注解，getAnnotations();
<b class="fc">&nbsp;        bind(type, implementation, implementation.getAnnotations());</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;Type, Implementation extends Type&gt;
&nbsp;    void bind(Class&lt;Type&gt; type, Class&lt;Implementation&gt; implementation, Annotation... annotations) {
&nbsp;        //scope
&nbsp;        //qualifier
&nbsp;        //illegal
<b class="fc">&nbsp;        Map&lt;Class&lt;?&gt;, List&lt;Annotation&gt;&gt; annotationGroups = stream(annotations).collect(Collectors.groupingBy(this::typeof, Collectors.toList()));</b>
&nbsp;        //TestLiteral就是不合规的，那么就是把TestLiteral放到了那个List中去了。
<b class="fc">&nbsp;        if (annotationGroups.containsKey(Illegal.class)) {</b>
<b class="fc">&nbsp;            throw new IllegalComponentException();</b>
&nbsp;        }
&nbsp;        //Java8有的新的方法，map如果获取不到，那么就可以给他一个默认值，如果获取不到Qualifier，那就给个空的List就好了
&nbsp;        //和之前的逻辑是一样的
&nbsp;        //根据Scope来获取到对应ScopeProvider，如果是Scope，那就是缓存一个，如果是Pool，那么就是缓存多个，在getScopeProvider
&nbsp;        //的时候就是去获取Pool的Provider，只有调用scope方法的时候，会添加一个scope到map中去，默认是Scope。如果bind了，获取到了
&nbsp;        //那么就用那个新的
<b class="fc">&nbsp;        bind(type, annotationGroups.getOrDefault(Qualifier.class,List.of()), createScopeProvider(implementation, annotationGroups.getOrDefault(Scope.class, List.of())));</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;Type&gt; ComponentProvider&lt;?&gt; createScopeProvider(Class&lt;Type&gt; implementation, List&lt;Annotation&gt; scopes) {
<b class="fc">&nbsp;        if(scopes.size() &gt; 1) throw new IllegalComponentException();</b>
<b class="fc">&nbsp;        ComponentProvider&lt;?&gt; injectionProvider = new InjectionProvider&lt;&gt;(implementation);</b>
&nbsp;
<b class="fc">&nbsp;        return scopes.stream().findFirst()</b>
<b class="fc">&nbsp;                .or(() -&gt; scopeFrom(implementation))</b>
<b class="fc">&nbsp;                .&lt;ComponentProvider&lt;?&gt;&gt;map(s -&gt; createScopeProvider(s, injectionProvider))</b>
<b class="fc">&nbsp;                .orElse(injectionProvider);</b>
&nbsp;    }
&nbsp;
&nbsp;    private &lt;Type&gt; void bind(Class&lt;Type&gt; type, List&lt;Annotation&gt; qualifiers, ComponentProvider&lt;?&gt; provider) {
<b class="fc">&nbsp;        if (qualifiers.isEmpty()) {</b>
<b class="fc">&nbsp;            components.put(new Component(type, null), provider);</b>
&nbsp;        }
<b class="fc">&nbsp;        for (Annotation qualifier : qualifiers) {</b>
<b class="fc">&nbsp;            components.put(new Component(type, qualifier), provider);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    private static &lt;Type&gt; Optional&lt;Annotation&gt; scopeFrom(Class&lt;Type&gt; implementation) {
<b class="fc">&nbsp;        return stream(implementation.getAnnotations()).filter(a -&gt; a.annotationType().isAnnotationPresent(Scope.class)).findFirst();</b>
&nbsp;    }
&nbsp;
&nbsp;    private Class&lt;?&gt; typeof(Annotation annotation) {
<b class="fc">&nbsp;        Class&lt;? extends Annotation&gt; type = annotation.annotationType();</b>
<b class="fc">&nbsp;        return Stream.of(Qualifier.class, Scope.class).filter(type::isAnnotationPresent).findFirst().orElse(Illegal.class);</b>
&nbsp;    }
&nbsp;
&nbsp;    private @interface Illegal {
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    private ComponentProvider&lt;?&gt; createScopeProvider(Annotation scope, ComponentProvider provider) {
<b class="fc">&nbsp;        if(!scopes.containsKey(scope.annotationType())) throw new IllegalComponentException();</b>
<b class="fc">&nbsp;        return scopes.get(scope.annotationType()).create(provider);</b>
&nbsp;    }
&nbsp;
&nbsp;    public &lt;ScopeType extends Annotation&gt; void scope(Class&lt;ScopeType&gt; scope,
&nbsp;                                                     ScopeProvider provider) {
<b class="fc">&nbsp;        scopes.put(scope, provider);</b>
&nbsp;    }
&nbsp;
&nbsp;    public Context getContext() {
&nbsp;        //这个dependencies中就是记录了所有的，还有你的参数中有的依赖，也去给你put进去，
&nbsp;
<b class="fc">&nbsp;        for (Component component : components.keySet()) {</b>
<b class="fc">&nbsp;            checkDependencies(component, new Stack&lt;&gt;());</b>
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        return new Context() {</b>
&nbsp;            @Override
&nbsp;            public &lt;ComponentType&gt; Optional&lt;ComponentType&gt; get(ComponentRef&lt;ComponentType&gt; ref) {
<b class="fc">&nbsp;                if (ref.isContainer()) {</b>
<b class="fc">&nbsp;                    if (ref.getContainer() != Provider.class) return Optional.empty();</b>
<b class="fc">&nbsp;                    return (Optional&lt;ComponentType&gt;) Optional.ofNullable(getComponent(ref))</b>
<b class="fc">&nbsp;                            .map(provider -&gt; (Provider&lt;Object&gt;) () -&gt; provider.get(this));</b>
&nbsp;                }
<b class="fc">&nbsp;                return Optional.ofNullable(getComponent(ref)).</b>
<b class="fc">&nbsp;                        map(provider -&gt; (ComponentType) provider.get(this));</b>
&nbsp;            }
&nbsp;
&nbsp;        };
&nbsp;    }
&nbsp;
&nbsp;    private &lt;ComponentType&gt; ComponentProvider&lt;?&gt; getComponent(ComponentRef&lt;ComponentType&gt; ref) {
<b class="fc">&nbsp;        return components.get(ref.component());</b>
&nbsp;    }
&nbsp;
&nbsp;    private void checkDependencies(Component component, Stack&lt;Component&gt; visiting) {
&nbsp;        /*注意原来的实现，dependencies.get(component)获取的是什么？是一个List，就是所有的依赖，然后接下来就是去判断
&nbsp;         * containsKey,如果没有Bind过，那么当然没有啊*/
&nbsp;        //这个是去找的所有bind过的依赖，然后把所有的key的依赖都放到一个栈中去，这里是找的所有的依赖，如果之前有添加过
&nbsp;        //那就说明有环了，就是有循环依赖
<b class="fc">&nbsp;        for (ComponentRef dependency : components.get(component).getDependencies()) {</b>
&nbsp;            //这个dependency.component()就是指的Dependency，其实就是dependency本身，但是有其他的属性，所以就
&nbsp;            //把属性封装到了component()这个方法中去，
<b class="fc">&nbsp;            if (!components.containsKey(dependency.component())) {</b>
<b class="fc">&nbsp;                throw new DependencyNotFoundException(component, dependency.component());</b>
&nbsp;            }
<b class="fc">&nbsp;            if (!dependency.isContainer()) {</b>
<b class="fc">&nbsp;                if (visiting.contains(dependency.component())) throw new CyclicDependenciesFoundException(visiting);</b>
<b class="fc">&nbsp;                visiting.push(dependency.component());</b>
<b class="fc">&nbsp;                checkDependencies(dependency.component(), visiting);</b>
&nbsp;//                checkDependencies(dependency.getComponent(), visiting);
<b class="fc">&nbsp;                visiting.pop();</b>
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-12-23 03:48</div>
</div>
</body>
</html>
